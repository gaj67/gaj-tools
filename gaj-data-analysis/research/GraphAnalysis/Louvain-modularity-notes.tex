\documentclass[a4paper]{article}
\usepackage{graphicx,subcaption}
\usepackage{amsmath,amsfonts}
\title{Notes on Louvain Modularity}
\author{G.A. Jarrad}
\begin{document}
\maketitle
\numberwithin{equation}{section}
\numberwithin{figure}{section}
\numberwithin{table}{section}
\section{Modularity}\label{sec:Q}
Let $D_{ij}$ represent the non-negative weight of a directed edge $i\rightarrow j$ (if one exists) 
from vertex $i\in{\cal V}$ to vertex $j\in{\cal V}$. Then the equivalent undirected edge is represented
by $A_{ij}=D_{ij}+D_{ji}-D_{ii}$, such that $A_{ij}=A_{ji}$. The total weight of all 
edges for vertex i (its so-called {\em vertex weight}) is then given by
\begin{eqnarray}
  A_{i\cdot} & = & \sum_{j\in{\cal V}} A_{ij}~=~\sum_{j\in{\cal V}} A_{ji}~=~A_{\cdot i}\,.
\end{eqnarray}
The sum of all vertex weights is then given by
\begin{eqnarray}
  A_{\cdot\cdot} & = & \sum_{i\in{\cal V}} A_{i\cdot}
  ~=~\sum_{i\in{\cal V}}\sum_{j\in{\cal V}} A_{ij}\,.
\end{eqnarray}
Note that this counts self edges (i.e.\ $i -- i$) once and all other edges (i.e.\ $i -- j$, 
$i\ne j$) twice. The Louvain modularity algorithm in fact assumes that there are no self edges, but we
shall include them here for completeness.

The modularity score of a clustered, undirected graph is then given by
\begin{eqnarray}
  Q & = & \sum_{i\in{\cal V}}\sum_{j\in{\cal V}} \left[
  \frac{A_{ij}}{A_{\cdot\cdot}}-
  \frac{A_{i\cdot}A_{\cdot j}}{A_{\cdot\cdot}^2}
  \right]\,\delta(c_i,c_j)\,,
\end{eqnarray}
where $c_i$ is the index of the cluster containing vertex $i$. Note that
$\delta(c_i,c_j)=1$ if and only if $c_i=c_j=g$ for some cluster index $g$. Then $Q$ can be
partitioned by cluster as
\begin{eqnarray}
  Q & = & \sum_{g=1}^G\sum_{i\in{\cal V}_g}\sum_{j\in{\cal V}_g} \left[
  \frac{A_{ij}}{A_{\cdot\cdot}}-
  \frac{A_{i\cdot}A_{\cdot j}}{A_{\cdot\cdot}^2}
  \right]~=~\sum_{g=1}^G Q_g\,,
\label{eq:Qg}
\end{eqnarray}
where the $g$-th cluster contains vertices ${\cal V}_g=\{i\in{\cal V}\;|\;c_i=g\}$,
and thus ${\cal V}=\bigcup_{g=1}^G {\cal V}_g$.

We now observe that the sum of edge weights of vertex $i$ for all edges to and from cluster $g$
is given by
\begin{eqnarray}
  A_{i,g} & = & \sum_{j\in{\cal V}_g} A_{ij}\,,
\end{eqnarray}
and hence the {\em internal} cluster weight, namely the total weight of all edges internal to 
cluster $g$, is given by
\begin{eqnarray}
   \Sigma_g^{\tt int} & = & \sum_{i\in{\cal V}_g}\sum_{j\in{\cal V}_g} A_{ij}
   ~=~\sum_{i\in{\cal V}_g} A_{i,g}\,.
\label{eq:sig:int}
\end{eqnarray}
Note that this value, like $A_{\cdot\cdot}$, also counts self edges ($i -- i$) once and other edges 
($i -- j$) twice.
Conversely, the {\em external} cluster weight, namely the total weight of all edges from vertices
in cluster $g$ to and from vertices in other clusters, is given by
\begin{eqnarray}
   \Sigma_g^{\tt ext} & = & \sum_{i\in{\cal V}_g}\sum_{j\nin{\cal V}_g} A_{ij}
   ~=~\sum_{j\nin{\cal V}_g} A_{j,g}\,.
\end{eqnarray}
Note that these edge weights are only counted once per cluster, but the edge $i -- j$ is 
counted for both the cluster containing vertex $i$ and the cluster containing vertex $j$.

The total weight of cluster $g$ is then given by
\begin{eqnarray}
   \Sigma_g^{\tt tot} & = & \Sigma_g^{\tt int} + \Sigma_g^{\tt ext}
\nonumber\\&=&
   \sum_{i\in{\cal V}_g}\sum_{j\in{\cal V}_g} A_{ij} 
   + \sum_{i\in{\cal V}_g}\sum_{j\nin{\cal V}_g} A_{ij}
\nonumber\\&=&
   \sum_{i\in{\cal V}_g}\sum_{j\in{\cal V}} A_{ij}~=~\sum_{i\in{\cal V}_g}A_{i\cdot}\,.
\label{eq:sig:tot}
 end{eqnarray}
We now observe that
\begin{eqnarray}
    \sum_{i\in{\cal V}_g}\sum_{j\in{\cal V}_g} A_{i\cdot}A_{\cdot j}
    & = & \sum_{i\in{\cal V}_g}A_{i\cdot}\sum_{j\in{\cal V}_g} A_{\cdot j}
\nonumber\\&=&
    \left(\sum_{i\in{\cal V}_g}A_{i\cdot}\right)\left(\sum_{j\in{\cal V}_g} A_{j\cdot}\right)
\nonumber\\&=&
    \left(\sum_{i\in{\cal V}_g}A_{i\cdot}\right)^2 ~=~ \left(\Sigma_g^{\tt tot}\right)^2\,.
\end{eqnarray}
Hence, from equation~\eqref{eq:Qg}, we see that the modularity score of the $g$-th cluster
simplifies to become
\begin{eqnarray}
   Q_g & = & \sum_{i\in{\cal V}_g}\sum_{j\in{\cal V}_g} \left[
  \frac{A_{ij}}{A_{\cdot\cdot}}-
  \frac{A_{i\cdot}A_{\cdot j}}{A_{\cdot\cdot}^2}
  \right]
\nonumber\\&=&
    \frac{\Sigma_g^{\tt int}}{A_{\cdot\cdot}}
    -\left(\frac{\Sigma_g^{\tt tot}}{A_{\cdot\cdot}}\right)^2\,.
\end{eqnarray}
This cluster modularity score $Q_g$ now gives us a handle on how to compute changes in score
due to changes in the graph clustering, with the aim of choosing a clustering that maximises
the total modularity score $Q$.

Suppose we merge a singleton cluster containing only vertex $k$ with another cluster $g$ to form a new
cluster $g\oplus k$. Then, from equation~\eqref{eq:sig:int}, the new internal cluster weight is
given by
\begin{eqnarray}
   \Sigma_{g\oplus k}^{\tt int} & = & \sum_{i\in{\cal V}_g\bigcup\{k\}}
   \sum_{j\in{\cal V}_g\bigcup\{k\}} A_{ij}
\nonumber\\&=&
    \sum_{i\in{\cal V}_g}\sum_{j\in{\cal V}_g} A_{ij}
    +\sum_{i\in{\cal V}_g}A_{ik}+\sum_{j\in{\cal V}_g}A_{kj}+A_{kk}
\nonumber\\&=&
    \Sigma_g^{\tt int}+2A_{k,g}+A_{kk}\,.
\label{eq:sig:int:add}
\end{eqnarray}
Similarly, the new total cluster weight is given by
\begin{eqnarray}
    \Sigma_{g\oplus k}^{\tt tot} & = & \sum_{i\in{\cal V}_g\bigcup\{k\}} A_{i\cdot}
\nonumber\\&=&
    \sum_{i\in{\cal V}_g A_{i\cdot}+A_{k\cdot}
    ~=~\Sigma_{g}^{\tt tot}+A_{k\cdot}\,,
\label{eq:sig:tot:add}
\end{eqnarray}
from equation~\eqref{eq:sig:tot}.
By extension, the singleton cluster for vertex $k$ was formed by merging with an empty cluster
with zero cluster weights, and so the modularity score of the singelton cluster is just
\begin{eqnarray}
    Q_k & = & \frac{A_{kk}}{A_{\cdot\cdot}}
    -\left(\frac{A_{k\cdot}}{A_{\cdot\cdot}}\right)^2\,.
\end{eqnarray}
Note that the Louvain modularity algorithm starts by placing every vertex $k\in{\cal V}$ into
its own singleton cluster, and so initially there are $G=|{\cal V}|$ such clusters.
Also note that, as mentioned above, the published Louvain algorithm assumes that $A_{kk}=0$.

We can now compute the total change in modularity caused by adding singleton vertex $k$
to cluster $g$, namely
\begin{eqnarray}
    \Delta Q_{g\oplus k} & = & Q_{g\oplus k}-(Q_g+Q_k)
\nonumber\\&=&
    \left[\frac{\Sigma_{g}^{\tt int}+2A_{k,g}+A_{kk}}{A_{\cdot\cdot}}
    -\left(\frac{\Sigma_{g}^{\tt tot}+A_{k\cdot}}{A_{\cdot\cdot}}\right)^2\right]
    -\left[\frac{\Sigma_{g}^{\tt int}}
    -\left(\frac{\Sigma_{g}^{\tt tot}}{A_{\cdot\cdot}}\right^2\right]
    -\left[\frac{A_{kk}}{A_{\cdot\cdot}}
    -\left(\frac{A_{k\cdot}}{A_{\cdot\cdot}}\right)^2\right]
\nonumber\\&=&
    \frac{2A_{k,g}}{A_{\cdot\cdot}}-\frac{2\Sigma_g^{\tt tot}A_{k\cdot}}{A_{\cdot\cdot}^2}\,,
\end{eqnarray}
from equations~\eqref{eq:sig:in:add} and~\eqref{eq:sig:tot:add}.

In the converse situation, we instead want to remove vertex $k$ from the cluster $g\oplus k$
that contains vertex $k$, and restore it to its singleton cluster. Since the action of 
adding the vertex (above) is reversible, then removing the vertex must result in a change of 
modularity score opposite to the change in score caused by adding the vertex. Hence, we obtain
\begin{eqnarray}
    \Delta Q_{(g\oplus k)\ominus k} & = & (Q_g+Q_k)-Q_{g\oplus k}
\nonumber\\&=&
    -\frac{2A_{k,g}}{A_{\cdot\cdot}}-\frac{2\Sigma_g^{\tt tot}A_{k\cdot}}{A_{\cdot\cdot}^2}\,,
\end{eqnarray}
where now $A_{k,g}$ is computed from $A_{k,g\oplus k}$ via
\begin{eqnarray}
    A_{k,g\oplus k} & = & \sum_{j\in{\cal V}_g\bigcup\{k\}}A_{kj}
    ~=~\sum_{j\in{\cal V}_g}A_{kj}+A_{kk}~=~A_{k,g}+A_{kk}\,,
\end{eqnarray}
and $\Sigma_g^{\tt tot}$ is computed from $\Sigma_{g\oplus k}^{\tt tot}$ via
equation~\eqref{eq:sig:tot:add}.
Hence, the combined action of removing vertex $k$ from cluster $g\oplus k$ (to form cluster $g$)
and adding it to cluster $g'$ (to form cluster $g'\oplus k$) gives rise to the total change of score
\begin{eqnarray}
    \Delta Q_{(g\oplus k)\ominus k,g'\oplus k} & = & \Delta Q_{(g\oplus k)\ominus k} + 
    \Delta Q_{g'\oplus k}
\end{eqnarray}

\end{document}
